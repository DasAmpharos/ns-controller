syntax = "proto3";

package ns_controller.v1;

// --- Inputs ---

// Bit assignments for Buttons.mask (bit N corresponds to (value N))
enum Button {
  // 0 is reserved in proto3 enums; we keep it unused.
  BUTTON_UNSPECIFIED = 0;

  // Face
  A        = 1;
  B        = 2;
  X        = 3;
  Y        = 4;

  // Shoulders (Z* are digital on Switch)
  L        = 5;
  R        = 6;
  ZL       = 7;
  ZR       = 8;

  // Stick-clicks
  L_STICK  = 9;   // L3
  R_STICK  = 10;  // R3

  // System
  PLUS     = 11;
  MINUS    = 12;
  HOME     = 13;
  CAPTURE  = 14;

  // D-Pad (treated as 4 digital buttons; host may also synthesize a hat)
  DPAD_UP    = 15;
  DPAD_DOWN  = 16;
  DPAD_LEFT  = 17;
  DPAD_RIGHT = 18;

  // Joy-Con SL/SR (useful when emulating single Joy-Con)
  SL       = 19;
  SR       = 20;
}

// Compact digital buttons representation.
// By default we use a 64-bit mask for simplicity/room to grow.
message Buttons {
  // Bitmask where bit index == enum numeric value (e.g., A=1 -> bit 1).
  // Example: (mask & (1 << A)) != 0 means "A is pressed".
  uint64 mask = 1;
  // Optional: explicit pressed list (handy for debugging). Avoid in hot paths.
  repeated Button pressed = 2 [packed = true];
}

// Analog stick with signed 16-bit style ranges.
// Use the standard gamepad convention: X right+, Y up+ (document your choice).
message Stick {
  // Range: -1..1
  float x = 1;
  float y = 2;
}

// Full controller state at an instant.
message ControllerState {
  // Digital buttons
  Buttons buttons = 1;
  // Analog sticks (use your deviceâ€™s calibration before populating these)
  Stick ls  = 2;
  Stick rs = 3;
}

message Ack {
  bool success = 1;
  ControllerState previous_state = 2;
}

// --- Service ---

service NsController {
  // Push a single instantaneous state to the server (fire-and-forget semantics
  // with an Ack so the client can track drops/retries).
  rpc SetState(ControllerState) returns (Ack);

  // Low-latency continuous updates. Client streams states; server sends acks.
  rpc StreamState(stream ControllerState) returns (Ack);
}
